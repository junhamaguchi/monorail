# 画像認識用モノレール模型制御システム 技術仕様書

## 1. システム概要

### 1.1 目的
画像認識システムの開発・研究用モノレール模型の制御システム
タミヤのモニレール工作キットの制御に使用
https://www.tamiya.com/japan/products/70254/index.html

### 1.2 対象ハードウェア
- Raspberry Pi Pico (RP2040)
- Kitronik Pico Motor Driver Board
- HC-SR04 超音波距離センサー
- DCモーター（12V推奨）
- 電源は単三電池X4

## 2. ハードウェア仕様

### 2.1 ピン配置

#### 超音波距離センサー（HC-SR04）
| 機能 | ピン番号 | 方向 | 説明 |
|------|----------|------|------|
| VCC | 3.3V | - | 電源供給 |
| GND | GND | - | グランド |
| TRIG | GPIO27 | 出力 | トリガーパルス |
| ECHO | GPIO26 | 入力 | エコーパルス |

#### モータードライバー（Kitronik）
| 機能 | ピン番号 | 方向 | 説明 |
|------|----------|------|------|
| Motor1 Forward | GPIO3 | 出力 | モーター1前進 |
| Motor1 Reverse | GPIO2 | 出力 | モーター1後退 |
| Motor2 Forward | GPIO6 | 出力 | モーター2前進 |
| Motor2 Reverse | GPIO7 | 出力 | モーター2後退 |

#### システムLED
| 機能 | ピン番号 | 方向 | 説明 |
|------|----------|------|------|
| LED | LED | 出力 | システム状態表示 |

### 2.2 電源仕様
- **動作電圧**: 3.3V（Pico）、12V（モーター）
- **消費電流**: 最大2A（モーター駆動時）
- **推奨電源**: 12V/2A以上

## 3. ソフトウェア仕様

### 3.1 開発環境
- **言語**: MicroPython
- **対象OS**: Raspberry Pi Pico
- **Python版**: 3.4以上

### 3.2 主要ライブラリ
```python
import sys
import _thread
from machine import Pin, time_pulse_us
import network
import socket
import time
import PicoMotorDriver
```

### 3.3 通信仕様

#### Wi-Fi設定
- **プロトコル**: IEEE 802.11 b/g/n
- **認証方式**: WPA2-PSK
- **接続方式**: Station Mode
- **IP取得**: DHCP

#### Webサーバー
- **プロトコル**: HTTP/1.1
- **ポート**: 80
- **同時接続数**: 1
- **タイムアウト**: 30秒

### 3.4 センサー仕様

#### 超音波距離センサー
- **測定範囲**: 2cm - 400cm
- **精度**: ±1cm
- **測定角度**: 15度
- **動作周波数**: 40kHz
- **トリガーパルス**: 10μs
- **最大待機時間**: 30ms

#### 距離計算式
```
距離(cm) = (パルス時間(μs) / 2) × 0.0343
```

### 3.5 モーター制御仕様

#### PWM制御
- **周波数**: 10kHz
- **分解能**: 16bit（0-65535）
- **速度範囲**: 0-100%
- **変換式**: PWM値 = 速度(%) × 655.35

#### 制御モード
| モード | 速度 | 説明 |
|--------|------|------|
| OFF | 0% | 停止 |
| ON1 | 100% | 最大速度 |
| ON2 | 90% | 高速 |
| ON3 | 80% | 中高速 |
| ON4 | 70% | 中速 |
| ON5 | 60% | 低速 |

## 4. 制御アルゴリズム

### 4.1 自動停止アルゴリズム

```python
# 状態遷移図
状態0（通常走行） → 距離<10cm → 状態1（停止中）
状態1（停止中） → 2秒経過 → 状態2（再開待機）
状態2（再開待機） → 距離>30cm → 状態0（通常走行）
```

### 4.2 マルチスレッド処理

#### スレッド構成
1. **メインスレッド**: Webサーバー処理
2. **モータースレッド**: モーター・センサー制御

#### 同期処理
- グローバル変数による速度制御
- 50ms間隔でのセンサー監視

## 5. セキュリティ仕様

### 5.1 ネットワークセキュリティ
- **アクセス制限**: ローカルネットワーク内のみ
- **認証**: Wi-Fiパスワード認証
- **暗号化**: WPA2暗号化

### 5.2 安全機能
- **距離監視**: 継続的な障害物検知
- **速度制限**: ソフトウェア・ハードウェア両面
- **緊急停止**: 障害物検知時の即座停止

## 6. パフォーマンス仕様

### 6.1 応答時間
- **Web制御**: <100ms
- **センサー応答**: <50ms
- **モーター制御**: <10ms

### 6.2 処理能力
- **センサー更新頻度**: 20Hz
- **Webサーバー処理**: 同時1接続
- **メモリ使用量**: <100KB

## 7. 拡張仕様

### 7.1 画像認識統合
- **カメラモジュール**: OV5647推奨
- **画像処理**: OpenCV MicroPython版
- **物体検知**: YOLO等の軽量モデル

### 7.2 追加センサー
- **GPS**: NEO-6M等
- **IMU**: MPU6050等
- **環境センサー**: BME280等

## 8. 制限事項

### 8.1 ハードウェア制限
- **同時接続数**: 1クライアントのみ
- **ファイルサイズ**: フラッシュメモリ容量依存
- **処理能力**: 単一コア処理

### 8.2 ソフトウェア制限
- **メモリ**: 264KB SRAM
- **ストレージ**: 2MB フラッシュ
- **同時実行**: 2スレッドまで

## 9. テスト仕様

### 9.1 機能テスト
- [ ] Wi-Fi接続テスト
- [ ] Webサーバー動作テスト
- [ ] モーター制御テスト
- [ ] 距離センサーテスト
- [ ] 自動停止機能テスト

### 9.2 性能テスト
- [ ] 応答時間測定
- [ ] 連続動作テスト
- [ ] 負荷テスト
- [ ] 温度テスト

## 10. 保守・運用

### 10.1 ログ出力
- **接続ログ**: クライアント接続情報
- **エラーログ**: センサーエラー等
- **動作ログ**: モーター制御履歴

### 10.2 更新方法
- **ファームウェア更新**: MicroPythonファイル置換
- **設定変更**: ソースコード編集
- **ライブラリ更新**: 個別ファイル更新

---

**文書バージョン**: 1.0  
**作成日**: 2024年  
**更新日**: 2024年 
